[General]
network = IVN_Network
sim-time-limit = 1s
description = "In-Vehicle Network"


#**.displayGateSchedules = true
#**.gateFilter = "**.eth[1].**"
**.gateScheduleVisualizer.height = 20
**.gateScheduleVisualizer.placementHint = "top"

**.macLayer.queue.queue[*].recordStats = true

## Record vectors emitted directly by queue[*] modules
**.macLayer.queue.queue[*].*.vector-recording = true
## Record vectors emitted by submodules or signals inside each queue[*]
**.macLayer.queue.queue[*].vector-recording = true

# gPTP protocol
*.*.hasTimeSynchronization = false

# master Clock
*.tsnClock.gptp.masterPorts = ["eth0"]

#Switch

# disable forwarding IEEE 802.1Q C-Tag
*.tsnSwitch.bridging.directionReverser.reverser.excludeEncapsulationProtocols = ["ieee8021qctag"]

# enable egress traffic shaping
*.tsnSwitch.hasEgressTrafficShaping = false

# time-aware traffic shaping
*.tsnSwitch.eth[*].macLayer.queue.numTrafficClasses = 8

*.tsnSwitch.eth[*].macLayer.pcpToQueueMapping = "0 1 2 3 4 5 6 7"

# Hyperperiod: 13 ms

#*.tsnSwitch.eth[*].macLayer.queue.*[7].display-name = "brake command"
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[7].offset = 0ms
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[7].durations = [6ms, 7ms] # [open, close]
#
#*.tsnSwitch.eth[*].macLayer.queue.*[6].display-name = "speed/torque command"
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[6].offset = 7ms
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[6].durations = [2ms, 11ms] # [open, close]
#
#*.tsnSwitch.eth[*].macLayer.queue.*[5].display-name = "torque limitation advisory"
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[5].offset = 5ms
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[5].durations = [1ms, 12ms] # [open, close]
#
#*.tsnSwitch.eth[*].macLayer.queue.*[4].display-name = "traction control update"
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[4].offset = 4ms
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[4].durations = [1ms, 12ms] # [open, close]
#
#*.tsnSwitch.eth[*].macLayer.queue.*[3].display-name = "road friction estimate"
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[3].offset = 3ms
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[3].durations = [1ms, 12ms] # [open, close]
#
#*.tsnSwitch.eth[*].macLayer.queue.*[2].display-name = "driving mode command"
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[2].offset = 2ms
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[2].durations = [1ms, 12ms] # [open, close]
#
#*.tsnSwitch.eth[*].macLayer.queue.*[1].display-name = "eco drive suggestion"
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[1].offset = 1ms
#*.tsnSwitch.eth[*].macLayer.queue.transmissionGate[1].durations = [1ms, 12ms] # [open, close]

# gPTP
*.tsnSwitch.gptp.slavePort = "eth4"
*.tsnSwitch.gptp.masterPorts = ["eth0","eth1","eth2", "eth3"]

# Per-Stream Filtering

# Per-Stream Filtering & Policing (PSFP) — EXTENDED FOR ALL 7 STREAMS
*.tsnSwitch.hasIngressTrafficFiltering = false

*.tsnSwitch.bridging.streamFilter.ingress.numStreams = 7

*.tsnSwitch.bridging.streamFilter.ingress.classifier.mapping = {
    "torque limitation advisory": 0,
    "traction control update": 1,
    "road friction estimate": 2,
    "speed/torque command": 3,
    "brake command": 4,
    "driving mode command": 5,
    "eco drive suggestion": 6}

*.tsnSwitch.bridging.streamFilter.ingress.meter[*].typename = "SingleRateTwoColorMeter"

# DISPLAY NAMES 
*.tsnSwitch.bridging.streamFilter.ingress.meter[0].display-name = "torque limitation advisory"
*.tsnSwitch.bridging.streamFilter.ingress.meter[1].display-name = "traction control update"
*.tsnSwitch.bridging.streamFilter.ingress.meter[2].display-name = "road friction estimate"
*.tsnSwitch.bridging.streamFilter.ingress.meter[3].display-name = "speed/torque command"
*.tsnSwitch.bridging.streamFilter.ingress.meter[4].display-name = "brake command"
*.tsnSwitch.bridging.streamFilter.ingress.meter[5].display-name = "driving mode command"
*.tsnSwitch.bridging.streamFilter.ingress.meter[6].display-name = "eco drive suggestion"

# CIR (Committed Information Rate)
# high-criticality → higher CIR
*.tsnSwitch.bridging.streamFilter.ingress.meter[0].committedInformationRate = 30Mbps   # torque limitation advisory
*.tsnSwitch.bridging.streamFilter.ingress.meter[1].committedInformationRate = 30Mbps   # traction control update
*.tsnSwitch.bridging.streamFilter.ingress.meter[2].committedInformationRate = 25Mbps   # road friction estimate
*.tsnSwitch.bridging.streamFilter.ingress.meter[3].committedInformationRate = 20Mbps   # speed/torque command
*.tsnSwitch.bridging.streamFilter.ingress.meter[4].committedInformationRate = 40Mbps   # brake command (highest)
*.tsnSwitch.bridging.streamFilter.ingress.meter[5].committedInformationRate = 10Mbps   # driving mode command
*.tsnSwitch.bridging.streamFilter.ingress.meter[6].committedInformationRate = 5Mbps    # eco drive suggestion

# CBS (Committed Burst Size)
*.tsnSwitch.bridging.streamFilter.ingress.meter[0].committedBurstSize = 10kB
*.tsnSwitch.bridging.streamFilter.ingress.meter[1].committedBurstSize = 10kB
*.tsnSwitch.bridging.streamFilter.ingress.meter[2].committedBurstSize = 10kB
*.tsnSwitch.bridging.streamFilter.ingress.meter[3].committedBurstSize = 5kB
*.tsnSwitch.bridging.streamFilter.ingress.meter[4].committedBurstSize = 10kB
*.tsnSwitch.bridging.streamFilter.ingress.meter[5].committedBurstSize = 5kB
*.tsnSwitch.bridging.streamFilter.ingress.meter[6].committedBurstSize = 5kB

# Tire pressure ECU
*.escECU.numApps = 3

# APP 1 CLIENT
*.escECU.app[0].typename = "UdpSourceApp"
*.escECU.app[0].display-name = "torque limitation advisory"
*.escECU.app[0].io.destPort = 1004
*.escECU.app[0].io.destAddress = "powerTrainECU"
*.escECU.app[0].source.productionInterval = 8ms
*.escECU.app[0].source.packetLength = 256B

# APP 2 CLIENT
*.escECU.app[1].typename = "UdpSourceApp"
*.escECU.app[1].display-name = "traction control update"
*.escECU.app[1].io.destPort = 1005
*.escECU.app[1].io.destAddress = "powerTrainECU"
*.escECU.app[1].source.productionInterval = 9ms
*.escECU.app[1].source.packetLength = 256B

# APP 3 CLIENT
*.escECU.app[2].typename = "UdpSourceApp"
*.escECU.app[2].display-name = "road friction estimate"
*.escECU.app[2].io.destPort = 1006
*.escECU.app[2].io.destAddress = "powerTrainECU"
*.escECU.app[2].source.productionInterval = 10ms
*.escECU.app[2].source.packetLength = 256B

# enable outgoing streams
*.escECU.hasOutgoingStreams = true

*.escECU.bridging.streamIdentifier.identifier.mapping = [{stream: "torque limitation advisory", packetFilter: expr(has(udp) && udp.destPort == 1004)},
														{stream: "traction control update", packetFilter: expr(has(udp) && udp.destPort == 1005)},
														{stream: "road friction estimate", packetFilter: expr(has(udp) && udp.destPort == 1006)}]
# client stream encoding
*.escECU.bridging.streamCoder.encoder.mapping = [{stream: "torque limitation advisory", pcp: 5},
												{stream: "traction control update", pcp: 4},
												{stream: "road friction estimate", pcp: 3}]

# Power train ECU

*.powerTrainECU.numApps = 7

*.powerTrainECU.app[0].typename = "UdpSinkApp"
*.powerTrainECU.app[0].io.localPort = 1000

*.powerTrainECU.app[1].typename = "UdpSinkApp"
*.powerTrainECU.app[1].io.localPort = 1003

*.powerTrainECU.app[2].typename = "UdpSinkApp"
*.powerTrainECU.app[2].io.localPort = 1004

*.powerTrainECU.app[3].typename = "UdpSinkApp"
*.powerTrainECU.app[3].io.localPort = 1005

*.powerTrainECU.app[4].typename = "UdpSinkApp"
*.powerTrainECU.app[4].io.localPort = 1006

*.powerTrainECU.app[5].typename = "UdpSinkApp"
*.powerTrainECU.app[5].io.localPort = 1007

*.powerTrainECU.app[6].typename = "UdpSinkApp"
*.powerTrainECU.app[6].io.localPort = 1008


# adaptiveCruiseControlECU
*.adaptiveCruiseControlECU.numApps = 2

# APP 1 - CLIENT 
*.adaptiveCruiseControlECU.app[0].typename = "UdpSourceApp"
*.adaptiveCruiseControlECU.app[0].display-name = "speed/torque command"
*.adaptiveCruiseControlECU.app[0].io.destPort = 1007
*.adaptiveCruiseControlECU.app[0].io.destAddress = "powerTrainECU"
*.adaptiveCruiseControlECU.app[0].source.productionInterval = 2ms
*.adaptiveCruiseControlECU.app[0].source.packetLength = 128B - 64B

# APP 2 - CLIENT
*.adaptiveCruiseControlECU.app[1].typename = "UdpSourceApp"
*.adaptiveCruiseControlECU.app[1].display-name = "brake command"
*.adaptiveCruiseControlECU.app[1].io.destPort = 1008
*.adaptiveCruiseControlECU.app[1].io.destAddress = "powerTrainECU"
*.adaptiveCruiseControlECU.app[1].source.productionInterval = 1ms
*.adaptiveCruiseControlECU.app[1].source.packetLength = 64B

# enable outgoing streams
*.adaptiveCruiseControlECU.hasOutgoingStreams = true

# client stream identification
*.adaptiveCruiseControlECU.bridging.streamIdentifier.identifier.mapping = [
    {stream: "speed/torque command", packetFilter: expr(has(udp) && udp.destPort == 1007)},
    {stream: "brake command", packetFilter: expr(has(udp) && udp.destPort == 1008)}]

# client stream encoding
*.adaptiveCruiseControlECU.bridging.streamCoder.encoder.mapping = [
    {stream: "speed/torque command", pcp: 6},
    {stream: "brake command", pcp: 7}]

# infotainmentECU

*.infotainmentECU.numApps = 2

*.infotainmentECU.hasOutgoingStreams = true

# APP 1 - driving mode command
*.infotainmentECU.app[0].typename = "UdpSourceApp"
*.infotainmentECU.app[0].display-name = "driving mode command"
*.infotainmentECU.app[0].io.destPort = 1000
*.infotainmentECU.app[0].io.destAddress = "powerTrainECU"
*.infotainmentECU.app[0].source.productionInterval = exponential(10ms)
*.infotainmentECU.app[0].source.packetLength = 500B

# APP 2 - eco drive suggestion
*.infotainmentECU.app[1].typename = "UdpSourceApp"
*.infotainmentECU.app[1].display-name = "eco drive suggestion"
*.infotainmentECU.app[1].io.destPort = 1003
*.infotainmentECU.app[1].io.destAddress = "powerTrainECU"
*.infotainmentECU.app[1].source.productionInterval = 0.0008s 
*.infotainmentECU.app[1].source.packetLength = 1000B            

# stream identification
*.infotainmentECU.bridging.streamIdentifier.identifier.mapping = [
    {stream: "driving mode command", packetFilter: expr(has(udp) && udp.destPort == 1000)},
    {stream: "eco drive suggestion", packetFilter: expr(has(udp) && udp.destPort == 1003)}]

# stream encoding
*.infotainmentECU.bridging.streamCoder.encoder.mapping = [
    {stream: "driving mode command", pcp: 2},
    {stream: "eco drive suggestion", pcp: 0}]



